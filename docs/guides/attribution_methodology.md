# Performance Attribution Methodology

This document details the mathematical and logical foundations of the performance attribution engine. The engine is designed to decompose a portfolio's active return—the difference between the portfolio's and the benchmark's Time-Weighted Return (TWR)—into its core drivers.
---

## 1. The Goal of Attribution

While TWR answers **what** a portfolio's return was, attribution answers **why** it differed from the benchmark. It systematically evaluates the two primary skills of a portfolio manager:

* **Allocation**: The ability to choose the right groups (e.g., sectors, asset classes) to be overweight or underweight in.
* **Selection**: The ability to pick outperforming securities within those groups.
The engine quantifies these skills into distinct effects that sum to the total active return.
---

## 2. Single-Period Attribution Models

For any single period (e.g., one month), the engine calculates three effects for each group *i*. The calculation requires the weight ($w$) and return ($R$) for the portfolio ($p$) and benchmark ($b$) for each group, as well as the total benchmark return ($R_b$).
### Brinson-Fachler (BF) Model

This is the industry-standard model and the default in our engine.
* **Allocation ($A_i$)**: $(w_{pi} - w_{bi}) \times (R_{bi} - R_b)$
    * *Interpretation*: Measures the impact of having a different weight in group *i* than the benchmark, multiplied by how much that group's benchmark return differed from the total benchmark return.
* **Selection ($S_i$)**: $w_{bi} \times (R_{pi} - R_{bi})$
    * *Interpretation*: Measures the impact of the portfolio's return outperformance within group *i*, scaled by the benchmark's weight in that group.
* **Interaction ($I_i$)**: $(w_{pi} - w_{bi}) \times (R_{pi} - R_{bi})$
    * *Interpretation*: A hybrid term that captures the combined impact of allocation and selection decisions.
For a single period, if the group weights sum to 100%, the effects will perfectly reconcile: $\sum (A_i + S_i + I_i) = R_p - R_b$.
---

## 3. The Challenge of Multi-Period Linking

Simply adding single-period attribution effects over a long horizon (e.g., a year) is mathematically incorrect because it ignores the effect of **compounding**. An allocation gain from January is reinvested and also generates returns in February. Consider a simple active return of `+1%` in January and `+0.5%` in February. The total active return is not `1.5%`. It is $(1.01 \times 1.005) - 1 = 1.505\%$. A simple sum misses the `0.005%` generated by compounding.
For true attribution, this compounding effect must be correctly distributed among the A, S, and I terms.
---

## 4. Multi-Period Linking: The Menchero Method

To solve the compounding problem, the engine uses the **Menchero linking algorithm** for geometric linking. This is a robust, industry-standard method that ensures the sum of the linked effects over the horizon perfectly reconciles to the total active return ($TWR_P - TWR_B$).

The Menchero method works by compounding each period's effects forward by the benchmark's subsequent returns.
* **Formula**: The total linked effect for a group *i* is the sum of its single-period effects, each multiplied by the benchmark's growth factor from that period to the end of the horizon.
$E'_{i} = \sum_{t=1}^{N} E_{i,t} \cdot (1 + R^{B}_{t+1 \rightarrow N})$

This method correctly accounts for how early gains are amplified by later market movements, providing a true picture of performance over time.
---

## 5. Hierarchical Analysis

The engine supports multi-level hierarchical attribution. When a hierarchy is provided in the request (e.g., `groupBy: ["assetClass", "sector"]`), the engine performs a **bottom-up aggregation**.

1.  Effects (Allocation, Selection, Interaction) are calculated at the most granular level (e.g., `sector`).
2.  The dollar effects for each component are then summed up to the parent levels (e.g., `assetClass`).

This approach ensures that the total effects at any level perfectly reconcile to the sum of the effects of their constituent children, providing a coherent and auditable breakdown of performance drivers across the entire hierarchy.

---

## 6. `by_instrument` Mode Aggregation

When provided with instrument-level data, the engine first calculates daily returns for each instrument using our core TWR engine. It then aggregates these to the group level before performing attribution.
* **Group Weight ($w_{pi}$)**: The sum of the weights of all instruments within the group.
$w_{pi,t} = \sum_{inst \in i} w_{inst,t}$
* **Group Return ($R_{pi}$)**: The weighted average of the returns of all instruments within the group.
$R_{pi,t} = \frac{\sum_{inst \in i} (w_{inst,t} \times R_{inst,t})}{w_{pi,t}}$